<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Five Crowns Scorer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <style>
        body { overscroll-behavior-y: none; background-color: #0f172a; color: white; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const ROUNDS = [
            { cards: 3, wild: 3, label: "3s Wild" }, { cards: 4, wild: 4, label: "4s Wild" },
            { cards: 5, wild: 5, label: "5s Wild" }, { cards: 6, wild: 6, label: "6s Wild" },
            { cards: 7, wild: 7, label: "7s Wild" }, { cards: 8, wild: 8, label: "8s Wild" },
            { cards: 9, wild: 9, label: "9s Wild" }, { cards: 10, wild: 10, label: "10s Wild" },
            { cards: 11, wild: 11, label: "Jacks Wild" }, { cards: 12, wild: 12, label: "Queens Wild" },
            { cards: 13, wild: 13, label: "Kings Wild" },
        ];

        function App() {
            const videoRef = useRef(null);
            const [model, setModel] = useState(null);
            const [labels, setLabels] = useState([]);
            const [roundIdx, setRoundIdx] = useState(0);
            const [hand, setHand] = useState([]);
            const [totalScore, setTotalScore] = useState(0);
            const [status, setStatus] = useState("Initializing...");
            const [cameraActive, setCameraActive] = useState(false);
            const [processing, setProcessing] = useState(false);

            // 1. Load Model
            useEffect(() => {
                async function loadAI() {
                    try {
                        let baseUrl = window.location.href.replace('index.html', '');
                        if (!baseUrl.endsWith('/')) baseUrl += '/';
                        
                        const modelUrl = baseUrl + 'model/model.json';
                        const metaUrl = baseUrl + 'model/metadata.json';
                        
                        setStatus("Loading Neural Net...");
                        
                        const [modelLoaded, metaRes] = await Promise.all([
                            tf.loadGraphModel(modelUrl),
                            fetch(metaUrl)
                        ]);

                        const metaJson = await metaRes.json();
                        setModel(modelLoaded);
                        setLabels(metaJson.labels);
                        setStatus("Ready to Start");
                    } catch (e) {
                        console.error(e);
                        setStatus("Model Error: " + e.message);
                    }
                }
                loadAI();
            }, []);

            // 2. Robust Camera Toggle
            const toggleCamera = async () => {
                if (cameraActive) {
                    const stream = videoRef.current.srcObject;
                    if (stream) stream.getTracks().forEach(t => t.stop());
                    videoRef.current.srcObject = null;
                    setCameraActive(false);
                    setStatus("Camera Stopped");
                } else {
                    setStatus("Requesting Camera...");
                    try {
                        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                            throw new Error("Browser does not support camera API");
                        }

                        let stream;
                        try {
                            // Try Rear Camera First
                            stream = await navigator.mediaDevices.getUserMedia({ 
                                video: { facingMode: "environment" } 
                            });
                        } catch (err) {
                            console.warn("Env camera failed, trying default", err);
                            // Fallback to ANY camera (laptop webcam, etc)
                            stream = await navigator.mediaDevices.getUserMedia({ video: true });
                        }
                        
                        if (videoRef.current) {
                            videoRef.current.srcObject = stream;
                            videoRef.current.onloadedmetadata = () => {
                                videoRef.current.play();
                                setCameraActive(true);
                                setStatus("Camera Active");
                            };
                        }
                    } catch (e) {
                        alert("Camera Failed: " + e.message);
                        setStatus("Camera Error");
                    }
                }
            };

            // 3. Scan Logic
            const scanCard = async () => {
                if (!model || !videoRef.current || processing) return;
                setProcessing(true);
                setStatus("Analyzing...");

                setTimeout(async () => {
                    try {
                        const predictionData = tf.tidy(() => {
                            const img = tf.browser.fromPixels(videoRef.current);
                            const [h, w] = img.shape;
                            const size = Math.min(h, w);
                            const startH = Math.floor((h - size) / 2);
                            const startW = Math.floor((w - size) / 2);
                            const cropped = img.slice([startH, startW, 0], [size, size, 3]);
                            const resized = tf.image.resizeBilinear(cropped, [224, 224]);
                            // Pass raw pixels (0-255) because model has Rescaling layer
                            const inputTensor = resized.toFloat().expandDims(0);
                            return model.predict(inputTensor);
                        });

                        const probs = await predictionData.data();
                        predictionData.dispose();

                        const maxProb = Math.max(...probs);
                        const classIdx = probs.indexOf(maxProb);
                        const label = labels[classIdx];

                        if (maxProb > 0.60) {
                            addCard(label);
                            setStatus(`Scanned: ${label.replace('_', ' ')}`);
                        } else {
                            setStatus(`Unsure (${Math.round(maxProb*100)}%). Try Closer.`);
                        }
                    } catch (e) {
                        console.error(e);
                        setStatus("Scan Error");
                    }
                    setProcessing(false);
                }, 50);
            };

            const addCard = (label) => {
                const parts = label.split('_');
                let rankStr = parts[1] || parts[0];
                let suit = parts.length > 1 ? parts[0] : "Special";
                
                let rankVal = parseInt(rankStr) || 0;
                if(rankStr === "Joker") rankVal = 50;
                if(["K","King"].includes(rankStr)) rankVal = 13;
                if(["Q","Queen"].includes(rankStr)) rankVal = 12;
                if(["J","Jack"].includes(rankStr)) rankVal = 11;

                setHand(prev => [{ id: Date.now(), raw: label, rankVal, display: rankStr, suit }, ...prev]);
            };

            const currentRound = ROUNDS[roundIdx];
            const handScore = hand.reduce((acc, c) => {
                if (c.rankVal === 50) return acc + 50;
                if (c.rankVal === currentRound.wild) return acc + 20;
                return acc + c.rankVal;
            }, 0);

            return (
                <div className="h-screen flex flex-col font-sans bg-slate-900 text-white">
                    {/* Header */}
                    <div className="p-4 bg-slate-800 shadow-md flex justify-between items-center z-10 shrink-0">
                        <div>
                            <div className="text-[10px] text-slate-400 uppercase font-bold tracking-wider">Total</div>
                            <div className="text-3xl font-black text-yellow-400">{totalScore + handScore}</div>
                        </div>
                        <div className="text-right">
                            <div className="text-[10px] text-slate-400 uppercase font-bold tracking-wider">Round {roundIdx + 1}</div>
                            <div className="text-xl font-bold">{currentRound.label}</div>
                        </div>
                    </div>

                    {/* Camera Area */}
                    <div className="flex-1 relative bg-black overflow-hidden flex items-center justify-center">
                        {!cameraActive && (
                            <div className="text-center p-4 z-10">
                                <p className="mb-4 text-slate-400 text-sm">Ready to play?</p>
                                <button onClick={toggleCamera} className="bg-blue-600 hover:bg-blue-500 text-white px-8 py-4 rounded-2xl font-bold shadow-lg transition-all active:scale-95">
                                    Start Camera
                                </button>
                            </div>
                        )}
                        
                        <video 
                            ref={videoRef} 
                            className={`absolute w-full h-full object-cover transition-opacity duration-500 ${cameraActive ? 'opacity-100' : 'opacity-0'}`} 
                            playsInline 
                            muted 
                        />
                        
                        {cameraActive && (
                            <>
                                <div className="absolute z-10 w-64 h-64 border-4 border-yellow-400/40 rounded-2xl shadow-[0_0_100px_rgba(0,0,0,0.5)] pointer-events-none"></div>
                                <div className="absolute top-6 bg-black/70 px-4 py-1 rounded-full text-sm backdrop-blur-sm z-20 font-medium border border-white/10">
                                    {status}
                                </div>
                            </>
                        )}
                    </div>

                    {/* Controls */}
                    <div className="h-[40%] bg-slate-900 flex flex-col rounded-t-3xl -mt-4 z-20 shadow-2xl border-t border-slate-800 shrink-0">
                        
                        {/* Scan Button */}
                        <div className="p-6 pb-2 flex justify-center">
                            {cameraActive ? (
                                <button 
                                    onClick={scanCard}
                                    disabled={processing}
                                    className={`w-full py-4 rounded-2xl text-xl font-black tracking-wide shadow-lg transition-all active:scale-95 flex items-center justify-center gap-3
                                        ${processing ? 'bg-slate-700 text-slate-400' : 'bg-yellow-500 text-slate-900 hover:bg-yellow-400'}`}
                                >
                                    {processing ? "..." : "SCAN CARD"}
                                </button>
                            ) : (
                                <div className="text-slate-500 text-sm italic py-4">Camera required</div>
                            )}
                        </div>

                        {/* Hand List */}
                        <div className="flex-1 overflow-y-auto px-4 space-y-2 pb-4 min-h-0">
                            {hand.length === 0 && cameraActive && <div className="text-center text-slate-600 text-xs mt-2">Hand is empty</div>}
                            {hand.map(card => {
                                const isWild = card.rankVal === currentRound.wild;
                                return (
                                    <div key={card.id} className={`flex justify-between items-center p-3 rounded-xl border shadow-sm ${isWild ? 'bg-yellow-900/20 border-yellow-600/50 text-yellow-100' : 'bg-slate-800 border-slate-700'}`}>
                                        <div className="flex items-center gap-4">
                                            <span className="font-black text-xl w-8 text-center">{card.display}</span>
                                            <div className="flex flex-col">
                                                <span className="text-[10px] uppercase opacity-60 font-bold tracking-wider">{card.suit}</span>
                                                {isWild && <span className="text-[10px] text-yellow-400 font-bold">WILD</span>}
                                            </div>
                                        </div>
                                        <button onClick={() => setHand(h => h.filter(x => x.id !== card.id))} className="text-red-400 p-2 hover:bg-white/5 rounded-full">✕</button>
                                    </div>
                                )
                            })}
                        </div>
                        
                        {/* Footer */}
                        <div className="p-3 bg-slate-800 flex justify-between items-center text-xs font-bold uppercase tracking-widest border-t border-slate-700 shrink-0">
                            <button onClick={() => {if(confirm("Reset game?")){setTotalScore(0); setHand([]); setRoundIdx(0);}}} className="text-slate-500 hover:text-white px-2">Reset</button>
                            <button onClick={() => {
                                if(confirm(`End round? (+${handScore})`)) {
                                    setTotalScore(s => s + handScore);
                                    setHand([]);
                                    setRoundIdx(r => Math.min(r+1, 10));
                                }
                            }} className="text-green-400 hover:text-green-300 px-2">Next Round →</button>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
