<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Five Crowns Scorer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <style>
        body { overscroll-behavior-y: none; background-color: #0f172a; color: white; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const ROUNDS = [
            { cards: 3, wild: 3, label: "3s Wild" }, { cards: 4, wild: 4, label: "4s Wild" },
            { cards: 5, wild: 5, label: "5s Wild" }, { cards: 6, wild: 6, label: "6s Wild" },
            { cards: 7, wild: 7, label: "7s Wild" }, { cards: 8, wild: 8, label: "8s Wild" },
            { cards: 9, wild: 9, label: "9s Wild" }, { cards: 10, wild: 10, label: "10s Wild" },
            { cards: 11, wild: 11, label: "Jacks Wild" }, { cards: 12, wild: 12, label: "Queens Wild" },
            { cards: 13, wild: 13, label: "Kings Wild" },
        ];

        function App() {
            const videoRef = useRef(null);
            const [model, setModel] = useState(null);
            const [labels, setLabels] = useState([]);
            const [roundIdx, setRoundIdx] = useState(0);
            const [hand, setHand] = useState([]);
            const [totalScore, setTotalScore] = useState(0);
            const [status, setStatus] = useState("Initializing...");
            const [cameraActive, setCameraActive] = useState(false);
            const [processing, setProcessing] = useState(false);

            // 1. Load Model & Metadata on Start
            useEffect(() => {
                async function loadAI() {
                    try {
                        // Construct paths relative to the index.html location
                        let baseUrl = window.location.href.replace('index.html', '');
                        if (!baseUrl.endsWith('/')) baseUrl += '/';
                        
                        const modelUrl = baseUrl + 'model/model.json';
                        const metaUrl = baseUrl + 'model/metadata.json';
                        
                        setStatus("Loading Model...");
                        
                        // Parallel load
                        const [modelLoaded, metaRes] = await Promise.all([
                            tf.loadGraphModel(modelUrl),
                            fetch(metaUrl)
                        ]);

                        const metaJson = await metaRes.json();
                        
                        setModel(modelLoaded);
                        setLabels(metaJson.labels);
                        setStatus("Ready");
                    } catch (e) {
                        console.error(e);
                        setStatus("Failed to load AI. Check files.");
                    }
                }
                loadAI();
            }, []);

            // 2. Camera Control
            const toggleCamera = async () => {
                if (cameraActive) {
                    // Stop Camera
                    const stream = videoRef.current.srcObject;
                    if (stream) {
                        stream.getTracks().forEach(track => track.stop());
                    }
                    videoRef.current.srcObject = null;
                    setCameraActive(false);
                } else {
                    // Start Camera
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({ 
                            video: { facingMode: "environment" } 
                        });
                        videoRef.current.srcObject = stream;
                        videoRef.current.onloadedmetadata = () => {
                            videoRef.current.play();
                            setCameraActive(true);
                        };
                    } catch (e) {
                        alert("Camera permission denied.");
                    }
                }
            };

            // 3. The "One Shot" Scan Logic
            const scanCard = async () => {
                if (!model || !videoRef.current || processing) return;
                setProcessing(true);
                setStatus("Analyzing...");

                // Small delay to ensure UI updates before heavy math freezes it
                setTimeout(async () => {
                    try {
                        const predictionData = tf.tidy(() => {
                            // A. Get Image from Video
                            const img = tf.browser.fromPixels(videoRef.current);
                            
                            // B. Crop Center Square (Crucial for accuracy)
                            const [h, w] = img.shape;
                            const size = Math.min(h, w);
                            const startH = Math.floor((h - size) / 2);
                            const startW = Math.floor((w - size) / 2);
                            const cropped = img.slice([startH, startW, 0], [size, size, 3]);

                            // C. Resize to 224x224
                            const resized = tf.image.resizeBilinear(cropped, [224, 224]);
                            
                            // *** FIX: DO NOT NORMALIZE MANUALLY ***
                            // The model has a Rescaling layer built-in. Pass raw pixels.
                            // Just cast to float and add batch dimension.
                            const inputTensor = resized.toFloat().expandDims(0);
                            
                            // D. Predict
                            return model.predict(inputTensor);
                        });

                        // E. Read Results
                        const probs = await predictionData.data();
                        predictionData.dispose(); // Clean up memory

                        // F. Find Best Match
                        const maxProb = Math.max(...probs);
                        const classIdx = probs.indexOf(maxProb);
                        const label = labels[classIdx];

                        if (maxProb > 0.50) { // Lower threshold slightly for robustness
                            addCard(label);
                            setStatus(`Scanned: ${label.replace('_', ' ')} (${Math.round(maxProb*100)}%)`);
                        } else {
                            setStatus("Not clear. Try closer.");
                        }
                    } catch (e) {
                        console.error(e);
                        setStatus("Error processing image.");
                    }
                    setProcessing(false);
                }, 50);
            };

            const addCard = (label) => {
                const parts = label.split('_');
                let rankStr = parts[1] || parts[0];
                let suit = parts.length > 1 ? parts[0] : "Special";
                
                let rankVal = parseInt(rankStr) || 0;
                if(rankStr === "Joker") rankVal = 50;
                if(["K","King"].includes(rankStr)) rankVal = 13;
                if(["Q","Queen"].includes(rankStr)) rankVal = 12;
                if(["J","Jack"].includes(rankStr)) rankVal = 11;

                setHand(prev => [{ id: Date.now(), raw: label, rankVal, display: rankStr, suit }, ...prev]);
            };

            // Score Calculation
            const currentRound = ROUNDS[roundIdx];
            const handScore = hand.reduce((acc, c) => {
                if (c.rankVal === 50) return acc + 50;
                if (c.rankVal === currentRound.wild) return acc + 20;
                return acc + c.rankVal;
            }, 0);

            return (
                <div className="h-screen flex flex-col font-sans bg-slate-900">
                    {/* --- HEADER --- */}
                    <div className="p-4 bg-slate-800 shadow-md flex justify-between items-center z-10">
                        <div>
                            <div className="text-[10px] text-slate-400 uppercase font-bold tracking-wider">Total</div>
                            <div className="text-3xl font-black text-yellow-400">{totalScore + handScore}</div>
                        </div>
                        <div className="text-right">
                            <div className="text-[10px] text-slate-400 uppercase font-bold tracking-wider">Round {roundIdx + 1}</div>
                            <div className="text-xl font-bold text-white">{currentRound.label}</div>
                        </div>
                    </div>

                    {/* --- CAMERA AREA --- */}
                    <div className="flex-1 relative bg-black overflow-hidden flex items-center justify-center">
                        {!cameraActive && (
                            <div className="text-slate-500 text-center p-4">
                                <p className="mb-4">Camera is off.</p>
                                <button onClick={toggleCamera} className="bg-slate-700 text-white px-6 py-3 rounded-xl font-bold">Start Camera</button>
                            </div>
                        )}
                        
                        <video 
                            ref={videoRef} 
                            className={`absolute w-full h-full object-cover transition-opacity ${cameraActive ? 'opacity-100' : 'opacity-0'}`} 
                            playsInline 
                            muted 
                        />
                        
                        {cameraActive && (
                            <>
                                {/* Targeting Reticle */}
                                <div className="absolute z-10 w-64 h-64 border-4 border-yellow-400/40 rounded-2xl shadow-[0_0_100px_rgba(0,0,0,0.5)]"></div>
                                {/* Status Badge */}
                                <div className="absolute top-6 bg-black/70 text-white px-4 py-1 rounded-full text-sm backdrop-blur-sm z-20 font-medium">
                                    {status}
                                </div>
                            </>
                        )}
                    </div>

                    {/* --- CONTROLS --- */}
                    <div className="h-[40%] bg-slate-900 flex flex-col rounded-t-3xl -mt-4 z-20 shadow-2xl border-t border-slate-800">
                        
                        {/* Main Button Area */}
                        <div className="p-6 pb-2 flex justify-center">
                            {cameraActive ? (
                                <button 
                                    onClick={scanCard}
                                    disabled={processing}
                                    className={`w-full py-4 rounded-2xl text-xl font-black tracking-wide shadow-lg transition-all active:scale-95 flex items-center justify-center gap-3
                                        ${processing ? 'bg-slate-700 text-slate-400' : 'bg-yellow-500 text-slate-900 hover:bg-yellow-400'}`}
                                >
                                    {processing ? (
                                        <span>PROCESSING...</span>
                                    ) : (
                                        <>
                                            <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={3}><path strokeLinecap="round" strokeLinejoin="round" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" /><path strokeLinecap="round" strokeLinejoin="round" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                                            <span>SCAN CARD</span>
                                        </>
                                    )}
                                </button>
                            ) : (
                                <div className="text-slate-500 text-sm italic py-4">Start camera to scan</div>
                            )}
                        </div>

                        {/* Card List */}
                        <div className="flex-1 overflow-y-auto px-4 space-y-2 pb-4">
                            {hand.length === 0 && cameraActive && <div className="text-center text-slate-600 text-xs mt-2">Tap scan to add cards</div>}
                            {hand.map(card => {
                                const isWild = card.rankVal === currentRound.wild;
                                return (
                                    <div key={card.id} className={`flex justify-between items-center p-3 rounded-xl border shadow-sm ${isWild ? 'bg-yellow-900/20 border-yellow-600/50 text-yellow-100' : 'bg-slate-800 border-slate-700 text-white'}`}>
                                        <div className="flex items-center gap-4">
                                            <span className="font-black text-xl w-8 text-center">{card.display}</span>
                                            <div className="flex flex-col">
                                                <span className="text-[10px] uppercase opacity-60 font-bold tracking-wider">{card.suit}</span>
                                                {isWild && <span className="text-[10px] text-yellow-400 font-bold">WILD CARD (20)</span>}
                                            </div>
                                        </div>
                                        <button onClick={() => setHand(h => h.filter(x => x.id !== card.id))} className="text-red-400 p-2 hover:bg-white/5 rounded-full">
                                            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clipRule="evenodd" /></svg>
                                        </button>
                                    </div>
                                )
                            })}
                        </div>

                        {/* Footer Controls */}
                        <div className="p-3 bg-slate-800 flex justify-between items-center text-xs font-bold uppercase tracking-widest border-t border-slate-700">
                            <button onClick={() => {if(confirm("Reset entire game?")){setTotalScore(0); setHand([]); setRoundIdx(0);}}} className="text-slate-500 hover:text-white px-2">Reset</button>
                            <button onClick={() => {
                                if(confirm(`Confirm round score: ${handScore}?`)) {
                                    setTotalScore(s => s + handScore);
                                    setHand([]);
                                    setRoundIdx(r => Math.min(r+1, 10));
                                }
                            }} className="text-green-400 hover:text-green-300 px-2 flex items-center gap-1">Next Round â†’</button>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
