<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Five Crowns: Graph Model</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <style>
        body { overscroll-behavior-y: none; background-color: #0f172a; color: white; }
        video { transform: scaleX(1); }
        .scan-region { border: 4px solid #eab308; box-shadow: 0 0 20px rgba(234, 179, 8, 0.5); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        function App() {
            const videoRef = useRef(null);
            const [model, setModel] = useState(null);
            const [labels, setLabels] = useState([]);
            const [prediction, setPrediction] = useState(null);
            const [confidence, setConfidence] = useState(0);
            const [isLoading, setIsLoading] = useState(true);
            const [error, setError] = useState('');
            const [cards, setCards] = useState([]);

            useEffect(() => {
                async function loadAssets() {
                    try {
                        let baseUrl = window.location.href.replace('index.html', '');
                        if (!baseUrl.endsWith('/')) baseUrl += '/';
                        
                        const modelUrl = baseUrl + 'model/model.json';
                        const metaUrl = baseUrl + 'model/metadata.json';
                        
                        // 1. Fetch Metadata
                        const metaRes = await fetch(metaUrl);
                        if (!metaRes.ok) throw new Error(`Metadata fetch failed: ${metaRes.status}`);
                        const metaData = await metaRes.json();
                        setLabels(metaData.labels);

                        // 2. Load Graph Model (The Modern Way)
                        // Note: loadGraphModel instead of loadLayersModel
                        const loadedModel = await tf.loadGraphModel(modelUrl);
                        setModel(loadedModel);
                        
                        setIsLoading(false);
                        startCamera();
                    } catch (err) {
                        console.error(err);
                        setError(err.message);
                    }
                }
                loadAssets();
            }, []);

            const startCamera = async () => {
                if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                        if (videoRef.current) {
                            videoRef.current.srcObject = stream;
                            videoRef.current.onloadedmetadata = () => {
                                videoRef.current.play();
                                requestAnimationFrame(predictLoop);
                            };
                        }
                    } catch (e) {
                        setError("Camera permission denied");
                    }
                }
            };

            const predictLoop = async () => {
                if (!videoRef.current || !model) return;
                
                const result = tf.tidy(() => {
                    const img = tf.browser.fromPixels(videoRef.current);
                    const [h, w] = img.shape;
                    const size = Math.min(h, w);
                    const startH = (h - size) / 2;
                    const startW = (w - size) / 2;
                    const cropped = img.slice([startH, startW, 0], [size, size, 3]);
                    const resized = tf.image.resizeBilinear(cropped, [224, 224]);
                    const normalized = resized.toFloat().div(127.5).sub(1);
                    
                    // Graph models expect inputs in a specific way, usually generic execution
                    return model.predict(normalized.expandDims(0));
                });

                const probs = await result.data();
                result.dispose();
                
                const maxProb = Math.max(...probs);
                const classIndex = probs.indexOf(maxProb);
                
                if (maxProb > 0.85) {
                    setPrediction(labels[classIndex]);
                    setConfidence(maxProb);
                } else {
                    setConfidence(maxProb);
                }
                requestAnimationFrame(predictLoop);
            };

            const addCurrentCard = () => {
                if (!prediction) return;
                const parts = prediction.split('_');
                let rank = parts[1] || parts[0];
                let color = parts.length > 1 ? parts[0] : "Special";
                setCards(prev => [{ id: Date.now(), rank, color, raw: prediction }, ...prev]);
            };

            return (
                <div className="h-screen flex flex-col font-mono">
                    <div className="relative flex-1 bg-black overflow-hidden flex justify-center items-center">
                        <video ref={videoRef} className="absolute min-w-full min-h-full object-cover opacity-60" playsInline muted />
                        
                        <div className="relative z-10 w-64 h-64 scan-region rounded-xl flex flex-col items-center justify-center p-4 text-center">
                             {isLoading && !error && <div className="text-yellow-400 font-bold animate-pulse">Loading Graph Model...</div>}
                             {error && <div className="bg-red-900/90 text-white p-2 rounded text-xs border border-red-500 w-full">{error}</div>}
                        </div>

                        <div className="absolute bottom-4 z-20 w-full px-4">
                            <div className="bg-slate-900/90 p-4 rounded-2xl border border-slate-700 text-center">
                                <div className="text-3xl font-black text-white mb-1">
                                    {prediction ? prediction.replace('_', ' ') : "Scanning..."}
                                </div>
                                <div className="text-xs text-slate-500">{(confidence * 100).toFixed(0)}% confident</div>
                            </div>
                        </div>
                    </div>

                    <div className="h-1/3 bg-slate-900 p-4 flex flex-col">
                        <button onClick={addCurrentCard} disabled={confidence < 0.85} className="w-full bg-yellow-500 hover:bg-yellow-400 disabled:opacity-50 disabled:bg-slate-700 text-slate-900 font-bold py-4 rounded-xl text-xl shadow-lg mb-4">
                            ADD CARD
                        </button>
                        <div className="flex-1 overflow-y-auto space-y-2">
                             {cards.map(c => (
                                <div key={c.id} className="flex justify-between items-center bg-slate-800 p-3 rounded border border-slate-700 text-xs">
                                    <span className="font-bold">{c.raw}</span>
                                    <button onClick={() => setCards(prev => prev.filter(x => x.id !== c.id))} className="text-red-400">âœ•</button>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
